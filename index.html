<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medusa e Mesa Dinâmica - Mapeamento</title>
    
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* --- Estilos Gerais --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --bg-color: #f0f2f5;
            --frame-color: #d1d5db;
            --frame-border-color: #a1a1aa;
            --socket-bg-color: #e5e7eb;
            --socket-border-color: #9ca3af;
            --connector-color: #1f2937;
            --primary-text-color: #111827;
            --secondary-text-color: #6b7280;
            --accent-color: #007bff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --button-bg-color: #007bff;
            --button-text-color: #ffffff;
            --desk-channel-bg: #fff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            font-weight: 500;
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .frame {
            position: relative;
            background: linear-gradient(145deg, #e1e1e1, #c8c8c8);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--frame-border-color);
            box-shadow: 0 5px 20px var(--shadow-color), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            margin-bottom: 2rem;
            width: 100%;
            max-width: 1200px;
        }
        
        .frame::before,
        .frame::after {
            content: '';
            position: absolute;
            background-color: #d1d5db;
            border: 1px solid var(--frame-border-color);
            width: 30px;
            height: 85%;
            top: 7.5%;
            border-radius: 4px;
            display: none;
        }
        .frame::before { left: -31px; }
        .frame::after { right: -31px; }

        .frame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .medusa-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        .channel-box {
            background-color: var(--socket-bg-color);
            border: 1px solid var(--socket-border-color);
            border-radius: 6px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            min-width: 0;
        }
        .channel-number { font-size: 0.75rem; font-weight: 700; color: var(--secondary-text-color); margin-bottom: 0.25rem; }
        .connector-socket { width: 35px; height: 35px; background-color: var(--connector-color); border-radius: 50%; margin-bottom: 0.5rem; border: 2px solid #d1d5db; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); flex-shrink: 0; }
        .channel-name { font-size: 0.8rem; font-weight: 500; word-wrap: break-word; width: 100%; padding: 0.2rem; border-radius: 4px; cursor: pointer; text-align: center; background-color: rgba(255,255,255,0.4); }
        .edit-input { width: 100%; background-color: #fff; border: 1px solid var(--accent-color); border-radius: 4px; padding: 0.2rem; font-size: 0.8rem; font-weight: 500; text-align: center; outline: none; }
        
        .desk-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .desk-channel-box {
            background-color: var(--desk-channel-bg);
            border: 1px solid var(--frame-border-color);
            border-radius: 6px;
            padding: 0.75rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .desk-channel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .desk-channel-number { font-size: 1.1rem; font-weight: 700; color: var(--primary-text-color); }
        .instrument-name { font-size: 0.9rem; color: var(--secondary-text-color); font-style: italic; text-align: right; }
        .source-selector { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--frame-border-color); background-color: #fff; font-family: 'Roboto', sans-serif; font-size: 1rem; }
        
        .actions-menu {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 400px;
            margin-top: -1rem;
            margin-bottom: 2rem;
        }
        .action-button {
            font-family: 'Roboto', sans-serif;
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .action-button:hover { background-color: #0056b3; transform: translateY(-2px); }

        @media (min-width: 768px) {
            body { padding: 2rem; }
            h2 { font-size: 1.8rem; }
            .frame { padding: 2rem; }
            .frame::before, .frame::after { display: block; }
            .medusa-grid { gap: 1.5rem; }
            .channel-box { padding: 0.75rem; }
            .channel-number { font-size: 0.9rem; margin-bottom: 0.5rem; }
            .connector-socket { width: 45px; height: 45px; }
            .channel-name, .edit-input { font-size: 1rem; padding: 0.25rem; }
            .desk-grid { grid-template-columns: repeat(2, 1fr); }
            .desk-channel-box.stereo { grid-column: span 2; }
            .actions-menu { flex-direction: row; }
        }

        @media (min-width: 992px) { .desk-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1200px) { .desk-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); } }
    </style>
</head>
<body>

    <div class="frame">
        <div class="frame-header">
            <h2>1. Mapeamento da Medusa (Palco)</h2>
        </div>
        <main id="medusa-grid" class="medusa-grid"></main>
    </div>

    <div class="frame">
        <div class="frame-header">
            <h2>2. Mapeamento da Mesa de Som (Patch)</h2>
        </div>
        <main id="desk-grid" class="desk-grid"></main>
    </div>

    <div class="actions-menu">
        <button id="backup-button" class="action-button">Salvar Backup (Exportar)</button>
        <button id="restore-button" class="action-button">Carregar Backup (Importar)</button>
        <input type="file" id="restore-input" accept=".json" style="display: none;">
    </div>

    <script>
        // Script principal da aplicação (sem alterações)
        document.addEventListener('DOMContentLoaded', () => {
            const medusaGrid = document.getElementById('medusa-grid');
            const deskGrid = document.getElementById('desk-grid');
            const backupBtn = document.getElementById('backup-button');
            const restoreBtn = document.getElementById('restore-button');
            const restoreInput = document.getElementById('restore-input');
            
            const MEDUSA_STORAGE_KEY = 'medusaChannelsData';
            const DESK_MAP_STORAGE_KEY = 'medusaDeskMapData';

            const defaultMedusaChannels = [
                { id: 1, name: 'Teclado (L)' }, { id: 2, name: 'Teclado (R)' }, { id: 3, name: 'Guitarra (L)' }, { id: 4, name: 'Guitarra (R)' },
                { id: 5, name: 'Sample Pad' }, { id: 6, name: 'Violão' }, { id: 7, name: 'Baixo' }, { id: 8, name: 'Bateria' },
                { id: 9, name: 'Aux. Fones' }, { id: 10, name: 'Clique' }, { id: 11, name: 'Par LED' }, { id: 12, name: 'Microfone 1' },
                { id: 13, name: 'Microfone 2' }, { id: 14, name: 'Microfone 3' }, { id: 15, name: 'Microfone 4' }, { id: 16, name: 'Sub' },
                { id: 17, name: 'PA Esquerdo' }, { id: 18, name: 'PA Direito' }, { id: 19, name: 'VS Esquerdo' }, { id: 20, name: 'VS Direito' }
            ];

            const defaultDeskMap = [
                { deskChannel: '1', medusaSourceId: null }, { deskChannel: '2', medusaSourceId: null },
                { deskChannel: '3', medusaSourceId: 19 }, { deskChannel: '4', medusaSourceId: 20 },
                { deskChannel: '5', medusaSourceId: null }, { deskChannel: '6', medusaSourceId: null },
                { deskChannel: '7', medusaSourceId: null }, { deskChannel: '8', medusaSourceId: null },
                { deskChannel: '9', medusaSourceId: null }, { deskChannel: '10', medusaSourceId: null },
                { deskChannel: '11', medusaSourceId: null }, { deskChannel: '12', medusaSourceId: null },
                { deskChannel: '13', medusaSourceId: null }, { deskChannel: '14', medusaSourceId: null },
                { deskChannel: '15', medusaSourceId: null },
                { deskChannel: '16/17', medusaSourceId: null }, { deskChannel: '18/19', medusaSourceId: null },
                { deskChannel: '20/21', medusaSourceId: null }, { deskChannel: '22/23', medusaSourceId: null }
            ];

            let medusaChannels = [];
            let deskMap = [];

            function loadData() {
                const savedMedusa = localStorage.getItem(MEDUSA_STORAGE_KEY);
                medusaChannels = savedMedusa ? JSON.parse(savedMedusa) : [...defaultMedusaChannels];
                const savedDeskMap = localStorage.getItem(DESK_MAP_STORAGE_KEY);
                deskMap = savedDeskMap ? JSON.parse(savedDeskMap) : [...defaultDeskMap];
            }

            function saveMedusaData() { localStorage.setItem(MEDUSA_STORAGE_KEY, JSON.stringify(medusaChannels)); }
            function saveDeskMapData() { localStorage.setItem(DESK_MAP_STORAGE_KEY, JSON.stringify(deskMap)); }

            function renderMedusa() {
                medusaGrid.innerHTML = '';
                medusaChannels.forEach(channel => {
                    const el = document.createElement('div');
                    el.className = 'channel-box';
                    el.dataset.id = channel.id;
                    el.innerHTML = `
                        <div class="channel-number">${String(channel.id).padStart(2, '0')}</div>
                        <div class="connector-socket"></div>
                        <div class="channel-name">${channel.name}</div>
                    `;
                    medusaGrid.appendChild(el);
                });
            }

            function renderDesk() {
                deskGrid.innerHTML = '';
                deskMap.forEach(deskChannel => {
                    const el = document.createElement('div');
                    const isStereo = deskChannel.deskChannel.includes('/');
                    el.className = `desk-channel-box ${isStereo ? 'stereo' : ''}`;
                    el.dataset.deskChannel = deskChannel.deskChannel;
                    const selectedMedusa = medusaChannels.find(mc => mc.id == deskChannel.medusaSourceId);
                    const instrumentName = selectedMedusa ? selectedMedusa.name : 'Não conectado';
                    let optionsHtml = '<option value="null">-- Vazio --</option>';
                    medusaChannels.forEach(mc => {
                        optionsHtml += `<option value="${mc.id}" ${mc.id == deskChannel.medusaSourceId ? 'selected' : ''}>
                            Medusa ${String(mc.id).padStart(2, '0')}: ${mc.name}
                        </option>`;
                    });
                    el.innerHTML = `
                        <div class="desk-channel-header">
                            <span class="desk-channel-number">${deskChannel.deskChannel}</span>
                            <span class="instrument-name">${instrumentName}</span>
                        </div>
                        <select class="source-selector">${optionsHtml}</select>
                    `;
                    deskGrid.appendChild(el);
                });
            }

            medusaGrid.addEventListener('click', (event) => {
                const channelNameElement = event.target.closest('.channel-name');
                if (!channelNameElement) return;
                const channelBox = channelNameElement.closest('.channel-box');
                if (channelBox.querySelector('.edit-input')) return;
                const currentName = channelNameElement.textContent;
                const channelId = channelBox.dataset.id;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'edit-input';
                input.value = currentName;
                channelNameElement.replaceWith(input);
                input.focus();
                const handleSaveChanges = () => {
                    const newName = input.value.trim() || 'Vazio';
                    const channelData = medusaChannels.find(c => c.id == channelId);
                    if (channelData) {
                        channelData.name = newName;
                        saveMedusaData();
                        renderDesk();
                    }
                    const newEl = document.createElement('div');
                    newEl.className = 'channel-name';
                    newEl.textContent = newName;
                    input.replaceWith(newEl);
                };
                input.addEventListener('blur', handleSaveChanges);
                input.addEventListener('keydown', (e) => e.key === 'Enter' && input.blur());
            });

            deskGrid.addEventListener('change', (event) => {
                if (event.target.classList.contains('source-selector')) {
                    const selector = event.target;
                    const deskChannelBox = selector.closest('.desk-channel-box');
                    const deskChannelId = deskChannelBox.dataset.deskChannel;
                    const selectedMedusaId = selector.value === 'null' ? null : parseInt(selector.value, 10);
                    const mapEntry = deskMap.find(dm => dm.deskChannel === deskChannelId);
                    if (mapEntry) {
                        mapEntry.medusaSourceId = selectedMedusaId;
                        saveDeskMapData();
                    }
                    const selectedMedusa = medusaChannels.find(mc => mc.id == selectedMedusaId);
                    const instrumentName = selectedMedusa ? selectedMedusa.name : 'Não conectado';
                    deskChannelBox.querySelector('.instrument-name').textContent = instrumentName;
                }
            });

            backupBtn.addEventListener('click', () => {
                const backupData = { medusaChannels: medusaChannels, deskMap: deskMap };
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'backup_medusa_e_mesa.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });

            restoreBtn.addEventListener('click', () => { restoreInput.click(); });

            restoreInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.medusaChannels && importedData.deskMap) {
                            medusaChannels = importedData.medusaChannels;
                            deskMap = importedData.deskMap;
                            saveMedusaData();
                            saveDeskMapData();
                            renderMedusa();
                            renderDesk();
                            alert('Backup carregado com sucesso!');
                        } else {
                            alert('Erro: Arquivo de backup inválido ou mal formatado.');
                        }
                    } catch (error) {
                        alert('Erro ao ler o arquivo de backup. Verifique se é um arquivo .json válido.');
                    }
                };
                reader.readAsText(file);
                restoreInput.value = '';
            });

            function init() { loadData(); renderMedusa(); renderDesk(); }
            init();
        });
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(registration => {
            console.log('Service Worker registrado com sucesso:', registration);
          }).catch(error => {
            console.log('Falha ao registrar o Service Worker:', error);
          });
        });
      }
    </script>
</body>
</html>